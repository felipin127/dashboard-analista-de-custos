import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# =============================================
# CONFIGURA√á√ÉO DA P√ÅGINA
# =============================================
st.set_page_config(
    page_title="Martins Analytics | An√°lise de Carnes",
    page_icon="ü•©",
    layout="wide",
    initial_sidebar_state="expanded"
)

# =============================================
# CSS PERSONALIZADO
# =============================================
st.markdown("""
<style>
    .stApp {
        background-color: #0E1117;
        color: #FAFAFA;
    }
    .main-header {
        background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
        padding: 2.5rem 1rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        text-align: center;
        border: 1px solid #FF6B6B;
    }
    .header-title {
        font-size: 2.8rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(45deg, #FFFFFF, #FFD700);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .analysis-section {
        background: linear-gradient(135deg, #1E293B 0%, #2D3748 100%);
        padding: 2rem;
        border-radius: 15px;
        border: 1px solid #4A5568;
        margin-bottom: 2rem;
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }
    .section-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: #FFD700;
        text-align: center;
        border-bottom: 2px solid #DC143C;
        padding-bottom: 0.5rem;
    }
    .upload-section {
        background: #1A202C;
        padding: 3rem;
        border-radius: 15px;
        border: 3px dashed #4A5568;
        margin-bottom: 2rem;
        text-align: center;
    }
    .info-box {
        background: #2D3748;
        padding: 1.5rem;
        border-radius: 10px;
        border-left: 4px solid #4299E1;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# =============================================
# FUN√á√ïES DE PROCESSAMENTO
# =============================================

def processar_dados_vendas(df_vendas):
    """Processa a base de vendas"""
    try:
        # Renomear colunas para padr√£o
        df_vendas_clean = df_vendas.copy()
        df_vendas_clean.columns = ['venda', 'cliente', 'vendedor', 'data', 'pagamento', 'valor']
        
        # Converter tipos
        df_vendas_clean['data'] = pd.to_datetime(df_vendas_clean['data'], format='%d/%m/%Y %H:%M', errors='coerce')
        df_vendas_clean['valor'] = df_vendas_clean['valor'].astype(str).str.replace(',', '.').astype(float)
        df_vendas_clean['venda'] = pd.to_numeric(df_vendas_clean['venda'], errors='coerce')
        
        # Extrair informa√ß√µes de tempo
        df_vendas_clean['hora'] = df_vendas_clean['data'].dt.hour
        df_vendas_clean['dia_semana'] = df_vendas_clean['data'].dt.day_name()
        df_vendas_clean['mes'] = df_vendas_clean['data'].dt.month_name()
        
        return df_vendas_clean
        
    except Exception as e:
        st.error(f"‚ùå Erro ao processar vendas: {str(e)}")
        return None

def processar_dados_estoque(df_estoque):
    """Processa a base de estoque/custos"""
    try:
        df_estoque_clean = df_estoque.copy()
        df_estoque_clean.columns = ['codigo', 'descricao', 'unidade', 'estoque', 'valor_estoque', 
                                  'qtd_devolvida', 'valor_devolvida', 'qtd', 'saldo']
        
        # Converter valores num√©ricos
        for col in ['estoque', 'valor_estoque', 'qtd_devolvida', 'valor_devolvida', 'qtd', 'saldo']:
            if col in df_estoque_clean.columns:
                df_estoque_clean[col] = df_estoque_clean[col].astype(str).str.replace(',', '.').astype(float)
        
        # Identificar produtos de carne
        df_estoque_clean['tipo_produto'] = df_estoque_clean['descricao'].apply(
            lambda x: 'CARNE' if 'CARNE' in str(x).upper() or 'AGEM' in str(x).upper() else 'OUTROS'
        )
        
        return df_estoque_clean
        
    except Exception as e:
        st.error(f"‚ùå Erro ao processar estoque: {str(e)}")
        return None

# =============================================
# FUN√á√ïES DE VISUALIZA√á√ÉO
# =============================================

def criar_metricas_principais(df_vendas, df_estoque):
    """Cria os cards com as m√©tricas principais"""
    st.markdown('## üìä Vis√£o Geral do Neg√≥cio')
    
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        receita_total = df_vendas['valor'].sum()
        st.metric("üí∞ Receita Total", f"R$ {receita_total:,.0f}")
    
    with col2:
        ticket_medio = df_vendas['valor'].mean()
        st.metric("üé´ Ticket M√©dio", f"R$ {ticket_medio:.2f}")
    
    with col3:
        total_vendas = len(df_vendas)
        st.metric("üìà Total de Vendas", f"{total_vendas}")
    
    with col4:
        if 'valor_estoque' in df_estoque.columns:
            valor_estoque_total = df_estoque['valor_estoque'].sum()
            st.metric("üì¶ Valor em Estoque", f"R$ {valor_estoque_total:,.0f}")
        else:
            st.metric("üì¶ Itens no Estoque", f"{len(df_estoque)}")
    
    with col5:
        produtos_carne = len(df_estoque[df_estoque['tipo_produto'] == 'CARNE'])
        st.metric("ü•© Produtos de Carne", f"{produtos_carne}")

# =============================================
# AN√ÅLISES PRINCIPAIS
# =============================================

def analise_horarios_pico(df_vendas):
    """An√°lise de Melhores Hor√°rios de Venda"""
    st.markdown('<div class="analysis-section">', unsafe_allow_html=True)
    st.markdown('<div class="section-title">‚è∞ Melhores Hor√°rios de Venda</div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Vendas por hora do dia
        vendas_hora = df_vendas.groupby('hora')['valor'].sum().reset_index()
        
        fig_hora = px.bar(vendas_hora, x='hora', y='valor', 
                         title='Faturamento por Hora do Dia',
                         labels={'hora': 'Hora do Dia', 'valor': 'Valor Total (R$)'},
                         color='valor',
                         color_continuous_scale='reds')
        
        fig_hora.update_layout(template='plotly_dark', showlegend=False)
        st.plotly_chart(fig_hora, use_container_width=True)
    
    with col2:
        # Vendas por dia da semana
        dias_ordem = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
        dias_portugues = {'Monday': 'Segunda', 'Tuesday': 'Ter√ßa', 'Wednesday': 'Quarta', 
                         'Thursday': 'Quinta', 'Friday': 'Sexta', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'}
        
        vendas_dia = df_vendas.groupby('dia_semana')['valor'].sum().reset_index()
        vendas_dia['dia_pt'] = vendas_dia['dia_semana'].map(dias_portugues)
        vendas_dia['dia_ordem'] = vendas_dia['dia_semana'].map({dia: i for i, dia in enumerate(dias_ordem)})
        vendas_dia = vendas_dia.sort_values('dia_ordem')
        
        fig_dia = px.line(vendas_dia, x='dia_pt', y='valor', 
                         title='Faturamento por Dia da Semana',
                         markers=True, line_shape='spline')
        fig_dia.update_layout(template='plotly_dark', showlegend=False)
        st.plotly_chart(fig_dia, use_container_width=True)
    
    # Insights
    hora_pico = vendas_hora.loc[vendas_hora['valor'].idxmax(), 'hora']
    dia_pico = vendas_dia.loc[vendas_dia['valor'].idxmax(), 'dia_pt']
    
    st.markdown(f"""
    <div class="info-box">
    <h4>üí° Insights Descobertos:</h4>
    <ul>
    <li><b>Hor√°rio de Pico:</b> {hora_pico}h - Maior movimento de vendas</li>
    <li><b>Dia Mais Rent√°vel:</b> {dia_pico} - Melhor desempenho semanal</li>
    <li><b>Recomenda√ß√£o:</b> Refor√ßar equipe nesses per√≠odos para melhor atendimento</li>
    </ul>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

def analise_desempenho_vendedores(df_vendas):
    """An√°lise de Desempenho da Equipe"""
    st.markdown('<div class="analysis-section">', unsafe_allow_html=True)
    st.markdown('<div class="section-title">üë• Desempenho da Equipe de Vendas</div>', unsafe_allow_html=True)
    
    # M√©tricas por vendedor
    perf_vendedores = df_vendas.groupby('vendedor').agg({
        'valor': ['sum', 'mean', 'count']
    }).round(2)
    
    perf_vendedores.columns = ['Receita Total', 'Ticket M√©dio', 'Total Vendas']
    perf_vendedores = perf_vendedores.sort_values('Receita Total', ascending=False)
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Gr√°fico de barras - Receita por vendedor
        fig_vendedores = px.bar(perf_vendedores.reset_index(), 
                               x='vendedor', y='Receita Total',
                               title='Performance - Receita por Vendedor',
                               color='Receita Total',
                               color_continuous_scale='reds')
        
        fig_vendedores.update_layout(template='plotly_dark', showlegend=False)
        st.plotly_chart(fig_vendedores, use_container_width=True)
    
    with col2:
        # Gr√°fico de pizza - Distribui√ß√£o de vendas
        fig_distribuicao = px.pie(perf_vendedores.reset_index(), 
                                 values='Receita Total', names='vendedor',
                                 title='Distribui√ß√£o de Receita entre Vendedores',
                                 hole=0.4)
        
        fig_distribuicao.update_layout(template='plotly_dark')
        st.plotly_chart(fig_distribuicao, use_container_width=True)
    
    # Tabela de performance SIMPLIFICADA
    st.subheader("üìã Ranking de Desempenho")
    
    # Criar tabela simples sem formata√ß√£o complexa
    tabela_simples = perf_vendedores.reset_index()
    tabela_simples['Posi√ß√£o'] = range(1, len(tabela_simples) + 1)
    tabela_simples = tabela_simples[['Posi√ß√£o', 'vendedor', 'Receita Total', 'Ticket M√©dio', 'Total Vendas']]
    
    # Formatar valores
    tabela_simples['Receita Total'] = tabela_simples['Receita Total'].apply(lambda x: f'R$ {x:,.2f}')
    tabela_simples['Ticket M√©dio'] = tabela_simples['Ticket M√©dio'].apply(lambda x: f'R$ {x:,.2f}')
    
    st.dataframe(tabela_simples, use_container_width=True)
    
    # Melhor vendedor
    melhor_vendedor = perf_vendedores.index[0]
    receita_melhor = perf_vendedores.iloc[0]['Receita Total']
    
    st.markdown(f"""
    <div class="info-box">
    <h4>üèÜ Destaque da Equipe:</h4>
    <p><b>{melhor_vendedor}</b> lidera com R$ {receita_melhor:,.2f} em vendas</p>
    <p><b>Sugest√£o:</b> Estude as estrat√©gias do vendedor top para replicar na equipe</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

def analise_preferencias_clientes(df_vendas):
    """An√°lise de Comportamento do Cliente"""
    st.markdown('<div class="analysis-section">', unsafe_allow_html=True)
    st.markdown('<div class="section-title">üí≥ Como Seus Clientes Preferem Pagar</div>', unsafe_allow_html=True)
    
    # An√°lise por forma de pagamento
    pagamento_stats = df_vendas.groupby('pagamento').agg({
        'valor': ['sum', 'mean', 'count']
    }).round(2)
    
    pagamento_stats.columns = ['Receita Total', 'Ticket M√©dio', 'Total Vendas']
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Pizza - Distribui√ß√£o de receita
        fig_pizza = px.pie(pagamento_stats.reset_index(), 
                          values='Receita Total', names='pagamento',
                          title='Distribui√ß√£o por Forma de Pagamento',
                          hole=0.4,
                          color_discrete_sequence=px.colors.sequential.Reds)
        
        fig_pizza.update_layout(template='plotly_dark')
        st.plotly_chart(fig_pizza, use_container_width=True)
    
    with col2:
        # Barras - Ticket m√©dio
        fig_ticket = px.bar(pagamento_stats.reset_index(), 
                           x='pagamento', y='Ticket M√©dio',
                           title='Ticket M√©dio por Forma de Pagamento',
                           color='Ticket M√©dio',
                           color_continuous_scale='reds')
        
        fig_ticket.update_layout(template='plotly_dark', showlegend=False)
        st.plotly_chart(fig_ticket, use_container_width=True)
    
    forma_mais_popular = pagamento_stats['Total Vendas'].idxmax()
    forma_maior_ticket = pagamento_stats['Ticket M√©dio'].idxmax()
    
    st.markdown(f"""
    <div class="info-box">
    <h4>üéØ Comportamento do Cliente:</h4>
    <ul>
    <li><b>Forma Mais Popular:</b> {forma_mais_popular} - Mais utilizada pelos clientes</li>
    <li><b>Maior Ticket M√©dio:</b> {forma_maior_ticket} - Clientes gastam mais</li>
    <li><b>Oportunidade:</b> Incentivar formas de pagamento com maior ticket m√©dio</li>
    </ul>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

def analise_gestao_estoque(df_estoque):
    """An√°lise Inteligente de Estoque"""
    st.markdown('<div class="analysis-section">', unsafe_allow_html=True)
    st.markdown('<div class="section-title">üì¶ Gest√£o Inteligente de Estoque</div>', unsafe_allow_html=True)
    
    # Filtrar apenas produtos de carne para an√°lise focada
    produtos_carne = df_estoque[df_estoque['tipo_produto'] == 'CARNE']
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Top produtos (usando as colunas dispon√≠veis)
        if not produtos_carne.empty:
            # Usar a primeira coluna num√©rica dispon√≠vel para o gr√°fico
            coluna_valor = 'valor_estoque' if 'valor_estoque' in produtos_carne.columns else 'estoque'
            top_produtos = produtos_carne.nlargest(10, coluna_valor)
            
            fig_produtos = px.bar(top_produtos, 
                                x='descricao', y=coluna_valor,
                                title='Principais Produtos em Estoque',
                                color=coluna_valor,
                                color_continuous_scale='reds')
            
            fig_produtos.update_layout(template='plotly_dark', xaxis_tickangle=45, showlegend=False)
            st.plotly_chart(fig_produtos, use_container_width=True)
        else:
            st.info("üìä N√£o h√° produtos de carne no estoque")
    
    with col2:
        # Distribui√ß√£o por tipo de produto
        dist_tipo = df_estoque['tipo_produto'].value_counts()
        fig_dist = px.pie(values=dist_tipo.values, names=dist_tipo.index,
                         title='Distribui√ß√£o de Produtos por Tipo')
        fig_dist.update_layout(template='plotly_dark')
        st.plotly_chart(fig_dist, use_container_width=True)
    
    # M√©tricas de estoque
    st.subheader("üìä Sa√∫de do Estoque")
    
    col_met1, col_met2, col_met3, col_met4 = st.columns(4)
    
    with col_met1:
        if 'valor_estoque' in df_estoque.columns:
            total_estoque = df_estoque['valor_estoque'].sum()
            st.metric("üí∞ Valor Total", f"R$ {total_estoque:,.0f}")
        else:
            st.metric("üìä Total Itens", f"{len(df_estoque)}")
    
    with col_met2:
        total_carnes = len(produtos_carne)
        st.metric("ü•© Itens de Carne", f"{total_carnes}")
    
    with col_met3:
        if 'qtd_devolvida' in df_estoque.columns:
            total_devolvido = df_estoque['qtd_devolvida'].sum()
            st.metric("üîÑ Devolu√ß√µes", f"{total_devolvido:.0f}")
        else:
            st.metric("üìà Tipos", f"{len(df_estoque['tipo_produto'].unique())}")
    
    with col_met4:
        if 'estoque' in df_estoque.columns:
            produtos_negativos = len(df_estoque[df_estoque['estoque'] < 0])
            st.metric("‚ö†Ô∏è Negativos", f"{produtos_negativos}")
        else:
            st.metric("üìã Categorias", f"{len(df_estoque)}")
    
    st.markdown('</div>', unsafe_allow_html=True)

# =============================================
# LAYOUT PRINCIPAL
# =============================================

def main():
    # Header
    st.markdown("""
    <div class='main-header'>
        <h1 class='header-title'>MARTINS ANALYTICS</h1>
        <p class='header-subtitle'>An√°lise Inteligente do Setor de Carnes</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar
    with st.sidebar:
        st.image("https://i.imgur.com/rLgn6yr.png", width=100)
        st.title("ü•© Martins Carnes")
        st.markdown("---")
        
        st.header("üìÅ Upload de Arquivos")
        
        st.subheader("üóÉÔ∏è Base de Vendas")
        arquivo_vendas = st.file_uploader("Selecione...", type=['xlsx', 'xls'], key='vendas')
        
        st.subheader("üì¶ Base de Estoque")
        arquivo_estoque = st.file_uploader("Selecione...", type=['xlsx', 'xls'], key='estoque')
        
        st.markdown("---")
        
        if st.button("üîÑ Recarregar An√°lise", use_container_width=True):
            st.rerun()
    
    # Processamento dos dados
    if arquivo_vendas is not None and arquivo_estoque is not None:
        try:
            with st.spinner('üîç Analisando seus dados...'):
                # Carregar dados
                df_vendas_raw = pd.read_excel(arquivo_vendas)
                df_estoque_raw = pd.read_excel(arquivo_estoque)
                
                # Processar dados
                df_vendas = processar_dados_vendas(df_vendas_raw)
                df_estoque = processar_dados_estoque(df_estoque_raw)
            
            if df_vendas is not None and df_estoque is not None:
                st.success("‚úÖ Dados carregados com sucesso!")
                
                # M√©tricas principais
                criar_metricas_principais(df_vendas, df_estoque)
                
                st.markdown("---")
                st.markdown('## üéØ An√°lises Inteligentes')
                
                # Executar todas as an√°lises
                analise_horarios_pico(df_vendas)
                analise_desempenho_vendedores(df_vendas)
                analise_preferencias_clientes(df_vendas)
                analise_gestao_estoque(df_estoque)
                
        except Exception as e:
            st.error(f"‚ùå Erro ao processar os arquivos: {str(e)}")
    
    else:
        # Tela inicial
        st.markdown("""
        <div class='upload-section'>
            <h2 style='color: #FFD700; margin-bottom: 1rem;'>üìä Bem-vindo ao Martins Analytics</h2>
            <p style='font-size: 1.2rem; margin-bottom: 2rem;'>
            Fa√ßa o upload das planilhas para descobrir insights valiosos sobre seu neg√≥cio.
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: #A0A0A0;'>
        ü•© <b>Martins Analytics</b> ‚Ä¢ An√°lise Especializada ‚Ä¢ ¬© 2024
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()